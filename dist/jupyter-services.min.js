"use strict";function extend(e,t){e=e||{};for(var n in t)e[n]="object"==typeof t[n]?extend(e[n],t[n]):t[n];return e}function uuid(){for(var e=[],t="0123456789ABCDEF",n=0;32>n;n++)e[n]=t.charAt(Math.floor(16*Math.random()));return e[12]="4",e[16]=t.charAt(3&Number(e[16])|8),e.join("")}function urlPathJoin(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];for(var n="",r=0;r<e.length;r++)""!==e[r]&&(n.length>0&&"/"!=n.charAt(n.length-1)?n=n+"/"+e[r]:n+=e[r]);return n.replace(/\/\/+/,"/")}function encodeURIComponents(e){return e.split("/").map(encodeURIComponent).join("/")}function urlJoinEncode(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return encodeURIComponents(urlPathJoin.apply(null,e))}function jsonToQueryString(e){return"?"+Object.keys(e).map(function(t){return encodeURIComponent(t)+"="+encodeURIComponent(e[t])}).join("&")}function ajaxRequest(e,t){return new Promise(function(n,r){var o=new XMLHttpRequest;o.open(t.method,e),t.contentType&&o.overrideMimeType(t.contentType),o.onload=function(){var e=o.response;"json"===t.dataType&&(e=JSON.parse(o.response)),n({data:e,statusText:o.statusText,xhr:o})},o.onerror=function(e){r({xhr:o,statusText:o.statusText,error:e})},t.data?o.send(t.data):o.send()})}function validateKernelId(e){if(!e.hasOwnProperty("name")||!e.hasOwnProperty("id"))throw Error("Invalid kernel id");if("string"!=typeof e.id||"string"!=typeof e.name)throw Error("Invalid kernel id")}function deserialize(e){var t;return t="string"==typeof e?JSON.parse(e):deserializeBinary(e)}function serialize(e){var t;return t=e.buffers&&e.buffers.length?serializeBinary(e):JSON.stringify(e)}function deserializeBinary(e){var t=new DataView(e),n=t.getUint32(0),r=[];if(2>n)throw new Error("Invalid incoming Kernel Message");for(var o=1;n>=o;o++)r.push(t.getUint32(4*o));var s=new Uint8Array(e.slice(r[0],r[1])),i=JSON.parse(new TextDecoder("utf8").decode(s));i.buffers=[];for(var o=1;n>o;o++){var a=r[o],u=r[o+1]||e.byteLength;i.buffers.push(new DataView(e.slice(a,u)))}return i}function serializeBinary(e){var t=[],n=[],r=new TextEncoder("utf8"),o=r.encode(JSON.stringify(e,replace_buffers));n.push(o.buffer);for(var s=0;s<e.buffers.length;s++){var i=e.buffers[s];n.push(i instanceof ArrayBuffer?i:i.buffer)}var a=n.length;for(t.push(4*(a+1)),s=0;s+1<n.length;s++)t.push(t[t.length-1]+n[s].byteLength);var u=new Uint8Array(t[t.length-1]+n[n.length-1].byteLength),l=new DataView(u.buffer);for(l.setUint32(0,a),s=0;s<t.length;s++)l.setUint32(4*(s+1),t[s]);for(s=0;s<n.length;s++)u.set(new Uint8Array(n[s]),t[s]);return u.buffer}function replace_buffers(e,t){return"buffers"===e?void 0:t}function validateSessionId(e){if(!e.hasOwnProperty("id")||!e.hasOwnProperty("notebook")||!e.hasOwnProperty("kernel"))throw Error("Invalid Session Model");if(kernel_1.validateKernelId(e.kernel),"string"!=typeof e.id)throw Error("Invalid Session Model");validateNotebookId(e.notebook)}function validateNotebookId(e){if(!e.hasOwnProperty("path")||"string"!=typeof e.path)throw Error("Invalid Notebook Model")}exports.extend=extend,exports.uuid=uuid,exports.urlPathJoin=urlPathJoin,exports.encodeURIComponents=encodeURIComponents,exports.urlJoinEncode=urlJoinEncode,exports.browser=function(){if("undefined"==typeof navigator)return["None"];var e,t=navigator.appName,n=navigator.userAgent,r=n.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\.?\d+(\.\d+)*)/i);return r&&null!==(e=n.match(/version\/([\.\d]+)/i))&&(r[2]=e[1]),r=r?[r[1],r[2]]:[t,navigator.appVersion,"-?"]}(),exports.jsonToQueryString=jsonToQueryString,exports.ajaxRequest=ajaxRequest;var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);n.prototype=t.prototype,e.prototype=new n},__decorate=this&&this.__decorate||function(e,t,n,r){if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)return Reflect.decorate(e,t,n,r);switch(arguments.length){case 2:return e.reduceRight(function(e,t){return t&&t(e)||e},t);case 3:return e.reduceRight(function(e,r){return void(r&&r(t,n))},void 0);case 4:return e.reduceRight(function(e,r){return r&&r(t,n,e)||e},r)}},signal=phosphor.core.signal,Disposable=phosphor.utility.Disposable,utils=require("./utils"),serialize_1=require("./serialize"),KERNEL_SERVICE_URL="api/kernel",kernel_log=Logger.get("kernel"),Kernel=function(){function e(e,t){this._id="",this._name="",this._baseUrl="",this._kernelUrl="",this._wsUrl="",this._username="",this._staticId="",this._ws=null,this._infoReply=null,this._reconnectLimit=7,this._autorestartAttempt=0,this._reconnectAttempt=0,this._handlerMap=null,this._iopubHandlers=null,this._status="",this._status="unknown",this._baseUrl=e,this._wsUrl=t,this._wsUrl||(this._wsUrl=location.protocol.replace("http","ws")+"//"+location.host),this._staticId=utils.uuid(),this._handlerMap=new Map,"undefined"==typeof WebSocket&&alert("Your browser does not have WebSocket support, please try Chrome, Safari, or Firefox â‰¥ 11.")}return e.list=function(e){var t=utils.urlJoinEncode(e,KERNEL_SERVICE_URL);return utils.ajaxRequest(t,{method:"GET",dataType:"json"}).then(function(e){if(200===e.xhr.status){if(!Array.isArray(e.data))throw Error("Invalid kernel list");for(var t=0;t<e.data.length;t++)validateKernelId(e.data[t]);return e.data}throw Error("Invalid Status: "+e.xhr.status)})},Object.defineProperty(e.prototype,"name",{get:function(){return this._name},set:function(e){this._name=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isConnected",{get:function(){return null===this._ws?!1:this._ws.readyState!==WebSocket.OPEN?!1:!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isFullyDisconnected",{get:function(){return null===this._ws},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"infoReply",{get:function(){return this._infoReply},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"status",{get:function(){return this._status},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"id",{get:function(){return this._id},set:function(e){this._id=e,this._kernelUrl=utils.urlJoinEncode(this._baseUrl,KERNEL_SERVICE_URL,this._id)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"wsUrl",{get:function(){return[this._wsUrl,utils.urlJoinEncode(this._kernelUrl,"channels"),"?session_id="+this._staticId].join("")},enumerable:!0,configurable:!0}),e.prototype.getInfo=function(){var e=this;return utils.ajaxRequest(this._kernelUrl,{method:"GET",dataType:"json"}).then(function(e){if(200!==e.xhr.status)throw Error("Invalid Status: "+e.xhr.status);return validateKernelId(e.data),e.data},function(t){e._onError(t)})},e.prototype.interrupt=function(){var e=this;this._handleStatus("interrupting");var t=utils.urlJoinEncode(this._kernelUrl,"interrupt");return console.log("hi there"),utils.ajaxRequest(t,{method:"POST",dataType:"json"}).then(function(e){if(204!==e.xhr.status)throw Error("Invalid Status: "+e.xhr.status)},function(t){e._onError(t)})},e.prototype.restart=function(){var e=this;this._handleStatus("restarting"),this.disconnect();var t=utils.urlJoinEncode(this._kernelUrl,"restart");return utils.ajaxRequest(t,{method:"POST",dataType:"json"}).then(function(t){if(200!==t.xhr.status)throw Error("Invalid Status: "+t.xhr.status);return validateKernelId(t.data),e.connect(),t.data},function(t){e._onError(t)})},e.prototype.start=function(e){var t=this;if(void 0!==e&&(console.log("setting this thing"),this.id=e.id,this.name=e.name),!this._kernelUrl)throw Error("You must set the kernel id before starting.");return utils.ajaxRequest(this._kernelUrl,{method:"POST",dataType:"json"}).then(function(e){if(200!==e.xhr.status)throw Error("Invalid Status: "+e.xhr.status);return validateKernelId(e.data),t.connect(e.data),e.data},function(e){t._onError(e)})},e.prototype["delete"]=function(){return utils.ajaxRequest(this._kernelUrl,{method:"DELETE",dataType:"json"}).then(function(e){if(204!==e.xhr.status)throw Error("Invalid response")})},e.prototype.connect=function(e){if(void 0!==e&&(this.id=e.id,this.name=e.name),!this._kernelUrl)throw Error("You must set the kernel id before starting");this._startChannels(),this._handleStatus("created")},e.prototype.reconnect=function(){this.isConnected||(this._reconnectAttempt=this._reconnectAttempt+1,this._handleStatus("reconnecting"),this._startChannels())},e.prototype.disconnect=function(){var e=this;null!==this._ws&&(this._ws.readyState===WebSocket.OPEN?(this._ws.onclose=function(){e._clearSocket()},this._ws.close()):this._clearSocket())},e.prototype.sendShellMessage=function(e,t,n,r){var o=this;if(void 0===n&&(n={}),void 0===r&&(r=[]),!this.isConnected)throw new Error("kernel is not connected");var s=this._createMsg(e,t,n,r);s.channel="shell",this._ws.send(serialize_1.serialize(s));var i=new KernelFutureHandler(function(){o._handlerMap["delete"](s.header.msgId)});return this._handlerMap.set(s.header.msgId,i),i},e.prototype.kernelInfo=function(){return this.sendShellMessage("kernel_info_request",{})},e.prototype.inspect=function(e,t){var n={code:e,cursor_pos:t,detail_level:0};return this.sendShellMessage("inspect_request",n)},e.prototype.execute=function(e,t){var n={code:e,silent:!0,store_history:!1,user_expressions:{},allow_stdin:!1};return utils.extend(n,t),this.sendShellMessage("execute_request",n)},e.prototype.complete=function(e,t){var n={code:e,cursor_pos:t};return this.sendShellMessage("complete_request",n)},e.prototype.sendInputReply=function(e){if(!this.isConnected)throw new Error("kernel is not connected");var t={value:e},n=this._createMsg("input_reply",t);return n.channel="stdin",this._ws.send(serialize_1.serialize(n)),n.header.msgId},e.prototype._createMsg=function(e,t,n,r){void 0===n&&(n={}),void 0===r&&(r=[]);var o={header:{msgId:utils.uuid(),username:this._username,session:this._staticId,msgType:e,version:"5.0"},metadata:n||{},content:t,buffers:r||[],parentHeader:{}};return o},e.prototype._handleStatus=function(e){this.statusChanged.emit(e),this._status=e;var t="Kernel: "+e+" ("+this._id+")";"idle"===e||"busy"===e?kernel_log.debug(t):kernel_log.info(t)},e.prototype._onError=function(e){var t="API request failed ("+e.statusText+"): ";throw kernel_log.error(t),Error(e.statusText)},e.prototype._startChannels=function(){var e=this;this.disconnect();var t=this._wsUrl+this._kernelUrl;kernel_log.info("Starting WebSockets:",t),this._ws=new WebSocket(this.wsUrl),this._ws.binaryType="arraybuffer";var n=!1;this._ws.onclose=function(r){n||(n=!0,r.wasClean||e.getInfo().then(function(){this._ws_closed(t,!1)},function(){this._kernel_dead()}))},this._ws.onerror=function(r){n||(n=!0,e._wsClosed(t,!0))},this._ws.onopen=function(t){e._wsOpened(t)};var r=function(r){n||(n=!0,r.wasClean||e._wsClosed(t,!1))};setTimeout(function(){null!==e._ws&&(e._ws.onclose=r)},1e3),this._ws.onmessage=function(t){e._handleWSMessage(t)}},e.prototype._clearSocket=function(){this._ws&&this._ws.readyState===WebSocket.CLOSED&&(this._ws=null)},e.prototype._kernelConnected=function(){var e=this;this._handleStatus("connected"),this._reconnectAttempt=0,this.kernelInfo().onReply(function(t){e._infoReply=t.content,console.log("info reply"),e._handleStatus("ready"),e._autorestartAttempt=0})},e.prototype._kernelDead=function(){this._handleStatus("dead"),this.disconnect()},e.prototype._wsOpened=function(e){this.isConnected&&this._kernelConnected()},e.prototype._wsClosed=function(e,t){this.disconnect(),this._handleStatus("disconnected"),t&&(kernel_log.error("WebSocket connection failed: ",e),this._handleStatus("connectionFailed")),this._scheduleReconnect()},e.prototype._scheduleReconnect=function(){var e=this;if(this._reconnectAttempt<this._reconnectLimit){var t=Math.pow(2,this._reconnectAttempt);kernel_log.error("Connection lost, reconnecting in "+t+" seconds."),setTimeout(function(){e.reconnect()},1e3*t)}else this._handleStatus("connectionDead"),kernel_log.error("Failed to reconnect, giving up.")},e.prototype._handleWSMessage=function(e){try{var t=serialize_1.deserialize(e.data)}catch(n){return void kernel_log.error(n.message)}if("iopub"===t.channel&&"status"===t.msgType&&this._handleStatusMessage(t),t.parentHeader){var r=t.parentHeader,o=this._handlerMap.get(r.msgId);o&&o.handleMsg(t)}},e.prototype._handleStatusMessage=function(e){var t=this,n=e.content.execution_state;"dead"!==n&&this._handleStatus(n),"starting"===n?this.kernelInfo().onReply(function(e){t._infoReply=e.content,t._handleStatus("ready"),t._autorestartAttempt=0}):"restarting"===n?(this._autorestartAttempt=this._autorestartAttempt+1,this._handleStatus("autorestarting")):"dead"===n&&this._kernelDead()},__decorate([signal],e.prototype,"statusChanged"),e}();exports.Kernel=Kernel;var KernelFutureFlag;!function(e){e[e.GotReply=1]="GotReply",e[e.GotIdle=2]="GotIdle",e[e.AutoDispose=4]="AutoDispose",e[e.IsDone=8]="IsDone"}(KernelFutureFlag||(KernelFutureFlag={}));var KernelFutureHandler=function(e){function t(){e.apply(this,arguments),this._status=0,this._input=null,this._output=null,this._reply=null,this._done=null}return __extends(t,e),Object.defineProperty(t.prototype,"autoDispose",{get:function(){return this._testFlag(KernelFutureFlag.AutoDispose)},set:function(e){e?this._setFlag(KernelFutureFlag.AutoDispose):this._clearFlag(KernelFutureFlag.AutoDispose)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isDone",{get:function(){return this._testFlag(KernelFutureFlag.IsDone)},enumerable:!0,configurable:!0}),t.prototype.onReply=function(e){return this._reply=e,this},t.prototype.onOutput=function(e){return this._output=e,this},t.prototype.onDone=function(e){return this._done=e,this},t.prototype.onInput=function(e){return this._input=e,this},t.prototype.handleMsg=function(e){if("iopub"===e.channel){var t=this._output;t&&t(e),"status"===e.msgType&&"idle"===e.content.execution_state&&(this._setFlag(KernelFutureFlag.GotIdle),this._testFlag(KernelFutureFlag.GotReply)&&this._handleDone(e))}else if("shell"===e.channel){var n=this._output;n&&n(e),this._setFlag(KernelFutureFlag.GotReply),this._testFlag(KernelFutureFlag.GotIdle)&&this._handleDone(e)}else if("stdin"===e.channel){var r=this._input;r&&r(e)}},t.prototype.dispose=function(){this._input=null,this._output=null,this._reply=null,this._done=null,e.prototype.dispose.call(this)},t.prototype._handleDone=function(e){this._setFlag(KernelFutureFlag.IsDone);var t=this._done;t&&t(e),this._reply=null,this._done=null,this._input=null,this._testFlag(KernelFutureFlag.AutoDispose)&&this.dispose()},t.prototype._testFlag=function(e){return 0!==(this._status&e)},t.prototype._setFlag=function(e){this._status|=e},t.prototype._clearFlag=function(e){this._status&=~e},t}(Disposable);exports.validateKernelId=validateKernelId,exports.deserialize=deserialize,exports.serialize=serialize;var __decorate=this&&this.__decorate||function(e,t,n,r){if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)return Reflect.decorate(e,t,n,r);switch(arguments.length){case 2:return e.reduceRight(function(e,t){return t&&t(e)||e},t);case 3:return e.reduceRight(function(e,r){return void(r&&r(t,n))},void 0);case 4:return e.reduceRight(function(e,r){return r&&r(t,n,e)||e},r)}},signal=phosphor.core.signal,utils=require("./utils"),kernel_1=require("./kernel"),SESSION_SERVICE_URL="api/sessions",session_log=Logger.get("session"),NotebookSession=function(){function e(e){this._id="unknown",this._notebookPath="unknown",this._baseUrl="unknown",this._sessionUrl="unknown",this._wsUrl="unknown",this._kernel=null,this._id=utils.uuid(),this._notebookPath=e.notebookPath,this._baseUrl=e.baseUrl,this._wsUrl=e.wsUrl,this._kernel=new kernel_1.Kernel(this._baseUrl,this._wsUrl),this._sessionUrl=utils.urlJoinEncode(this._baseUrl,SESSION_SERVICE_URL,this._id)}return e.list=function(e){var t=utils.urlJoinEncode(e,SESSION_SERVICE_URL);return utils.ajaxRequest(t,{method:"GET",dataType:"json"}).then(function(e){if(200!==e.xhr.status)throw Error("Invalid Status: "+e.xhr.status);if(!Array.isArray(e.data))throw Error("Invalid Session list");for(var t=0;t<e.data.length;t++)validateSessionId(e.data[t]);return e.data})},Object.defineProperty(e.prototype,"kernel",{get:function(){return this._kernel},enumerable:!0,configurable:!0}),e.prototype.start=function(){var e=this,t=utils.urlJoinEncode(this._baseUrl,SESSION_SERVICE_URL);return utils.ajaxRequest(t,{method:"POST",dataType:"json",data:JSON.stringify(this._model),contentType:"application/json"}).then(function(t){if(201!==t.xhr.status)throw Error("Invalid response");return validateSessionId(t.data),e._kernel.connect(t.data.kernel),e._handleStatus("kernelCreated"),t.data},function(t){e._handleStatus("kernelDead")})},e.prototype.getInfo=function(){return utils.ajaxRequest(this._sessionUrl,{method:"GET",dataType:"json"}).then(function(e){if(200!==e.xhr.status)throw Error("Invalid response");return validateSessionId(e.data),e.data})},e.prototype["delete"]=function(){return this._kernel&&(this._handleStatus("kernelKilled"),this._kernel.disconnect()),utils.ajaxRequest(this._sessionUrl,{method:"DELETE",dataType:"json"}).then(function(e){if(204!==e.xhr.status)throw Error("Invalid response");validateSessionId(e.data)},function(e){if(410===e.xhr.status)throw Error("The kernel was deleted but the session was not");throw Error(e.statusText)})},e.prototype.restart=function(e){var t=this;return this["delete"]().then(function(){return t.start()})["catch"](function(){return t.start()}).then(function(){e&&e.notebookPath&&(t._notebookPath=e.notebookPath),e&&e.kernelName&&(t._kernel.name=e.kernelName)})},e.prototype.renameNotebook=function(e){return this._notebookPath=e,utils.ajaxRequest(this._sessionUrl,{method:"PATCH",dataType:"json",data:JSON.stringify(this._model),contentType:"application/json"}).then(function(e){if(200!==e.xhr.status)throw Error("Invalid response");return validateSessionId(e.data),e.data})},Object.defineProperty(e.prototype,"_model",{get:function(){return{id:this._id,notebook:{path:this._notebookPath},kernel:{name:this._kernel.name,id:this._kernel.id}}},enumerable:!0,configurable:!0}),e.prototype._handleStatus=function(e){this.statusChanged.emit(e),session_log.error("Session: "+e+" ("+this._id+")")},__decorate([signal],e.prototype,"statusChanged"),e}();exports.NotebookSession=NotebookSession;