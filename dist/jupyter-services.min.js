"use strict";define(["require","exports"],function(t,e){function n(t,e){t=t||{};for(var r in e)t[r]="object"==typeof e[r]?n(t[r],e[r]):e[r];return t}function r(){for(var t=[],e="0123456789ABCDEF",n=0;32>n;n++)t[n]=e.charAt(Math.floor(16*Math.random()));return t[12]="4",t[16]=e.charAt(3&Number(t[16])|8),t.join("")}function o(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];for(var n="",r=0;r<t.length;r++)""!==t[r]&&(n.length>0&&"/"!=n.charAt(n.length-1)?n=n+"/"+t[r]:n+=t[r]);return n.replace(/\/\/+/,"/")}function s(t){return t.split("/").map(encodeURIComponent).join("/")}function i(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return s(o.apply(null,t))}function a(t){return"?"+Object.keys(t).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(t[e])}).join("&")}function u(t,e){return new Promise(function(n,r){var o=new XMLHttpRequest;o.open(e.method,t),e.contentType&&o.overrideMimeType(e.contentType),o.onload=function(){var t=o.response;"json"===e.dataType&&(t=JSON.parse(o.response)),n({data:t,statusText:o.statusText,xhr:o})},o.onerror=function(t){r({xhr:o,statusText:o.statusText,error:t})},e.data?o.send(e.data):o.send()})}e.extend=n,e.uuid=r,e.urlPathJoin=o,e.encodeURIComponents=s,e.urlJoinEncode=i,e.browser=function(){if("undefined"==typeof navigator)return["None"];var t,e=navigator.appName,n=navigator.userAgent,r=n.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\.?\d+(\.\d+)*)/i);return r&&null!==(t=n.match(/version\/([\.\d]+)/i))&&(r[2]=t[1]),r=r?[r[1],r[2]]:[e,navigator.appVersion,"-?"]}(),e.jsonToQueryString=a,e.ajaxRequest=u}),define(["require","exports"],function(t,e){function n(t){var e;return e="string"==typeof t?JSON.parse(t):o(t)}function r(t){var e;return e=t.buffers&&t.buffers.length?s(t):JSON.stringify(t)}function o(t){var e=new DataView(t),n=e.getUint32(0),r=[];if(2>n)throw new Error("Invalid incoming Kernel Message");for(var o=1;n>=o;o++)r.push(e.getUint32(4*o));var s=new Uint8Array(t.slice(r[0],r[1])),i=JSON.parse(new TextDecoder("utf8").decode(s));i.buffers=[];for(var o=1;n>o;o++){var a=r[o],u=r[o+1]||t.byteLength;i.buffers.push(new DataView(t.slice(a,u)))}return i}function s(t){var e=[],n=[],r=new TextEncoder("utf8"),o=r.encode(JSON.stringify(t,i));n.push(o.buffer);for(var s=0;s<t.buffers.length;s++){var a=t.buffers[s];n.push(a instanceof ArrayBuffer?a:a.buffer)}var u=n.length;for(e.push(4*(u+1)),s=0;s+1<n.length;s++)e.push(e[e.length-1]+n[s].byteLength);var h=new Uint8Array(e[e.length-1]+n[n.length-1].byteLength),c=new DataView(h.buffer);for(c.setUint32(0,u),s=0;s<e.length;s++)c.setUint32(4*(s+1),e[s]);for(s=0;s<n.length;s++)h.set(new Uint8Array(n[s]),e[s]);return h.buffer}function i(t,e){return"buffers"===t?void 0:e}e.deserialize=n,e.serialize=r});var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);n.prototype=e.prototype,t.prototype=new n},__decorate=this&&this.__decorate||function(t,e,n,r){if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)return Reflect.decorate(t,e,n,r);switch(arguments.length){case 2:return t.reduceRight(function(t,e){return e&&e(t)||t},e);case 3:return t.reduceRight(function(t,r){return void(r&&r(e,n))},void 0);case 4:return t.reduceRight(function(t,r){return r&&r(e,n,t)||t},r)}};define(["require","exports","./serialize","./utils"],function(t,e,n,r){function o(t){if(!t.hasOwnProperty("name")||!t.hasOwnProperty("id"))throw Error("Invalid kernel id");if("string"!=typeof t.id||"string"!=typeof t.name)throw Error("Invalid kernel id")}var s=phosphor.core.signal,i=phosphor.utility.Disposable,a="api/kernel",u=Logger.get("kernel"),h=function(){function t(t,e){this._id="unknown",this._name="unknown",this._baseUrl="unknown",this._kernelUrl="unknown",this._wsUrl="unknown",this._username="unknown",this._staticId="unknown",this._ws=null,this._infoReply=null,this._reconnectLimit=7,this._autorestartAttempt=0,this._reconnectAttempt=0,this._handlerMap=null,this._iopubHandlers=null,this._status="unknown",this._baseUrl=t,this._wsUrl=e,this._wsUrl||(this._wsUrl=location.protocol.replace("http","ws")+"//"+location.host),this._staticId=r.uuid(),this._handlerMap=new Map,"undefined"==typeof WebSocket&&alert("Your browser does not have WebSocket support, please try Chrome, Safari, or Firefox â‰¥ 11.")}return t.list=function(t){var e=r.urlJoinEncode(t,a);return r.ajaxRequest(e,{method:"GET",dataType:"json"}).then(function(t){if(200===t.xhr.status){if(!Array.isArray(t.data))throw Error("Invalid kernel list");for(var e=0;e<t.data.length();e++)o(t.data[e]);return t.data}throw Error("Invalid Status: "+t.xhr.status)})},Object.defineProperty(t.prototype,"name",{get:function(){return this._name},set:function(t){this._name=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isConnected",{get:function(){return null===this._ws?!1:this._ws.readyState!==WebSocket.OPEN?!1:!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isFullyDisconnected",{get:function(){return null===this._ws},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"infoReply",{get:function(){return this._infoReply},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"status",{get:function(){return this._status},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),t.prototype.getInfo=function(){var t=this;return r.ajaxRequest(this._kernelUrl,{method:"GET",dataType:"json"}).then(function(t){if(200!==t.xhr.status)throw Error("Invalid Status: "+t.xhr.status);return o(t.data),t.data},function(e){t._onError(e)})},t.prototype.interrupt=function(){var t=this;this._handleStatus("interrupting");var e=r.urlJoinEncode(this._kernelUrl,"interrupt");return r.ajaxRequest(e,{method:"POST",dataType:"json"}).then(function(t){if(204!==t.xhr.status)throw Error("Invalid Status: "+t.xhr.status)},function(e){t._onError(e)})},t.prototype.restart=function(){var t=this;this._handleStatus("restarting"),this.disconnect();var e=r.urlJoinEncode(this._kernelUrl,"restart");return r.ajaxRequest(e,{method:"POST",dataType:"json"}).then(function(e){if(200!==e.xhr.status)throw Error("Invalid Status: "+e.xhr.status);t.connect(e.data)},function(e){t._onError(e)})},t.prototype.connect=function(t){this._id=t.id,this._kernelUrl=r.urlJoinEncode(this._baseUrl,a,this._id),this._name=t.name,this._startChannels(),this._handleStatus("created")},t.prototype.reconnect=function(){this.isConnected||(this._reconnectAttempt=this._reconnectAttempt+1,this._handleStatus("reconnecting"),this._startChannels())},t.prototype.disconnect=function(){var t=this;null!==this._ws&&(this._ws.readyState===WebSocket.OPEN?(this._ws.onclose=function(){t._clearSocket()},this._ws.close()):this._clearSocket())},t.prototype.sendShellMessage=function(t,e,r,o){var s=this;if(void 0===r&&(r={}),void 0===o&&(o=[]),!this.isConnected)throw new Error("kernel is not connected");var i=this._createMsg(t,e,r,o);i.channel="shell",this._ws.send(n.serialize(i));var a=new l(function(){s._handlerMap["delete"](i.header.msgId)});return this._handlerMap.set(i.header.msgId,a),a},t.prototype.kernelInfo=function(){return this.sendShellMessage("kernel_info_request",{})},t.prototype.inspect=function(t,e){var n={code:t,cursor_pos:e,detail_level:0};return this.sendShellMessage("inspect_request",n)},t.prototype.execute=function(t,e){var n={code:t,silent:!0,store_history:!1,user_expressions:{},allow_stdin:!1};return r.extend(n,e),this.sendShellMessage("execute_request",n)},t.prototype.complete=function(t,e){var n={code:t,cursor_pos:e};return this.sendShellMessage("complete_request",n)},t.prototype.sendInputReply=function(t){if(!this.isConnected)throw new Error("kernel is not connected");var e={value:t},r=this._createMsg("input_reply",e);return r.channel="stdin",this._ws.send(n.serialize(r)),r.header.msgId},t.prototype._createMsg=function(t,e,n,o){void 0===n&&(n={}),void 0===o&&(o=[]);var s={header:{msgId:r.uuid(),username:this._username,session:this._staticId,msgType:t,version:"5.0"},metadata:n||{},content:e,buffers:o||[],parentHeader:{}};return s},t.prototype._handleStatus=function(t){this.statusChanged.emit(t),this._status=t;var e="Kernel: "+t+" ("+this._id+")";"idle"===t||"busy"===t?u.debug(e):u.info(e)},t.prototype._onError=function(t){var e="API request failed ("+t.statusText+"): ";throw u.error(e),Error(t.statusText)},t.prototype._startChannels=function(){var t=this;this.disconnect();var e=this._wsUrl+this._kernelUrl;u.info("Starting WebSockets:",e),this._ws=new WebSocket([this._wsUrl,r.urlJoinEncode(this._kernelUrl,"channels"),"?session_id="+this._staticId].join("")),this._ws.binaryType="arraybuffer";var n=!1;this._ws.onclose=function(r){n||(n=!0,r.wasClean||t.getInfo().then(function(){this._ws_closed(e,!1)},function(){this._kernel_dead()}))},this._ws.onerror=function(r){n||(n=!0,t._wsClosed(e,!0))},this._ws.onopen=function(e){t._wsOpened(e)};var o=function(r){n||(n=!0,r.wasClean||t._wsClosed(e,!1))};setTimeout(function(){null!==t._ws&&(t._ws.onclose=o)},1e3),this._ws.onmessage=function(e){t._handleWSMessage(e)}},t.prototype._clearSocket=function(){this._ws&&this._ws.readyState===WebSocket.CLOSED&&(this._ws=null)},t.prototype._kernelConnected=function(){var t=this;this._handleStatus("connected"),this._reconnectAttempt=0,this.kernelInfo().onReply(function(e){t._infoReply=e.content,t._handleStatus("ready"),t._autorestartAttempt=0})},t.prototype._kernelDead=function(){this._handleStatus("dead"),this.disconnect()},t.prototype._wsOpened=function(t){this.isConnected&&this._kernelConnected()},t.prototype._wsClosed=function(t,e){this.disconnect(),this._handleStatus("disconnected"),e&&(u.error("WebSocket connection failed: ",t),this._handleStatus("connectionFailed")),this._scheduleReconnect()},t.prototype._scheduleReconnect=function(){var t=this;if(this._reconnectAttempt<this._reconnectLimit){var e=Math.pow(2,this._reconnectAttempt);u.error("Connection lost, reconnecting in "+e+" seconds."),setTimeout(function(){t.reconnect()},1e3*e)}else this._handleStatus("connectionDead"),u.error("Failed to reconnect, giving up.")},t.prototype._handleWSMessage=function(t){try{var e=n.deserialize(t.data)}catch(r){return void u.error(r.message)}if("iopub"===e.channel&&"status"===e.msgType&&this._handleStatusMessage(e),e.parentHeader){var o=e.parentHeader,s=this._handlerMap.get(o.msgId);s&&s.handleMsg(e)}},t.prototype._handleStatusMessage=function(t){var e=this,n=t.content.execution_state;"dead"!==n&&this._handleStatus(n),"starting"===n?this.kernelInfo().onReply(function(t){e._infoReply=t.content,e._handleStatus("ready"),e._autorestartAttempt=0}):"restarting"===n?(this._autorestartAttempt=this._autorestartAttempt+1,this._handleStatus("autorestarting")):"dead"===n&&this._kernelDead()},__decorate([s],t.prototype,"statusChanged"),t}();e.Kernel=h;var c;!function(t){t[t.GotReply=1]="GotReply",t[t.GotIdle=2]="GotIdle",t[t.AutoDispose=4]="AutoDispose",t[t.IsDone=8]="IsDone"}(c||(c={}));var l=function(t){function e(){t.apply(this,arguments),this._status=0,this._input=null,this._output=null,this._reply=null,this._done=null}return __extends(e,t),Object.defineProperty(e.prototype,"autoDispose",{get:function(){return this._testFlag(c.AutoDispose)},set:function(t){t?this._setFlag(c.AutoDispose):this._clearFlag(c.AutoDispose)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isDone",{get:function(){return this._testFlag(c.IsDone)},enumerable:!0,configurable:!0}),e.prototype.onReply=function(t){return this._reply=t,this},e.prototype.onOutput=function(t){return this._output=t,this},e.prototype.onDone=function(t){return this._done=t,this},e.prototype.onInput=function(t){return this._input=t,this},e.prototype.handleMsg=function(t){if("iopub"===t.channel){var e=this._output;e&&e(t),"status"===t.msgType&&"idle"===t.content.execution_state&&(this._setFlag(c.GotIdle),this._testFlag(c.GotReply)&&this._handleDone(t))}else if("shell"===t.channel){var n=this._output;n&&n(t),this._setFlag(c.GotReply),this._testFlag(c.GotIdle)&&this._handleDone(t)}else if("stdin"===t.channel){var r=this._input;r&&r(t)}},e.prototype.dispose=function(){this._input=null,this._output=null,this._reply=null,this._done=null,t.prototype.dispose.call(this)},e.prototype._handleDone=function(t){this._setFlag(c.IsDone);var e=this._done;e&&e(t),this._reply=null,this._done=null,this._input=null,this._testFlag(c.AutoDispose)&&this.dispose()},e.prototype._testFlag=function(t){return 0!==(this._status&t)},e.prototype._setFlag=function(t){this._status|=t},e.prototype._clearFlag=function(t){this._status&=~t},e}(i);e.validateKernelId=o});